---
import Layout from '../layouts/Layout.astro';
import YearBadge from '../components/YearBadge.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');

// Group posts by year and sort
const postsByYear = new Map<number, typeof allPosts>();

allPosts.forEach(post => {
  const year = parseInt(post.data.date.split('-')[0]);
  if (!postsByYear.has(year)) {
    postsByYear.set(year, []);
  }
  postsByYear.get(year)!.push(post);
});

// Sort posts within each year by date (newest first)
postsByYear.forEach(posts => {
  posts.sort((a, b) => {
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  });
});

// Get sorted years (newest first)
const years = Array.from(postsByYear.keys()).sort((a, b) => b - a);
---

<Layout title="Home">
  <h1>Welcome to My Personal Website</h1>
  <p>This is a minimal, Jake-like personal website built with Astro.</p>
  
  <h2>Blog Posts by Year</h2>
  {years.length > 0 ? (
    <div>
      {years.map(year => (
        <div key={year} style={{ marginBottom: '2rem' }}>
          <YearBadge year={year} />
          <ul style={{ marginTop: '0.5rem' }}>
            {postsByYear.get(year)?.map(post => (
              <li key={post.id}>
                <a href={`/blog/${year}/${post.slug}`}>{post.data.title}</a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  ) : (
    <p>No blog posts yet.</p>
  )}
</Layout>
