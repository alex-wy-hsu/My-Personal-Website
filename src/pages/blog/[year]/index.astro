---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  
  // Get unique years from posts
  const years = new Set<number>();
  posts.forEach(post => {
    const year = parseInt(post.data.date.split('-')[0]);
    years.add(year);
  });

  return Array.from(years).map(year => ({
    params: { year: year.toString() },
  }));
}

const { year } = Astro.params;
const yearNum = parseInt(year!);

// Filter and sort posts for this year
const yearPosts = allPosts
  .filter(post => {
    const postYear = parseInt(post.data.date.split('-')[0]);
    return postYear === yearNum;
  })
  .sort((a, b) => {
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  });
---

<Layout title={`Blog - ${year}`}>
  <h1>Blog Posts - {year}</h1>
  
  {yearPosts.length > 0 ? (
    <ul>
      {yearPosts.map(post => (
        <li key={post.id}>
          <a href={`/blog/${year}/${post.slug}`}>{post.data.title}</a>
          <span> ({post.data.date})</span>
        </li>
      ))}
    </ul>
  ) : (
    <p>No posts found for {year}.</p>
  )}
</Layout>